<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Golf Club Info</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <h1>Golf Club Info</h1>

  <div id="club-info">
    <p><strong>Brand / Model:</strong> <span id="club-brand-model">Not set</span></p>
    <p><strong>Club type:</strong> <span id="club-type">Not set</span></p>
    <p><strong>Typical distance:</strong> <span id="club-distance">Not set</span></p>
    <p><strong>Shot / use:</strong> <span id="club-use">Not set</span></p>
    <p><strong>Consistent swing:</strong> <span id="club-consistency">Not set</span></p>

    <div class="notes-box">
      <strong>Swing notes:</strong>
      <div id="club-notes" class="notes-content">None</div>
    </div>
  </div>

  <button id="editBtn">Edit</button>

  <div id="footer">Smitty built</div>

  <script>
    const WORKER_URL = "https://billowing-bonus-bca7.blessingspoint.workers.dev";

    function setText(id, value, fallback = "Not set") {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = (value && String(value).trim()) ? value : fallback;
    }

    function render(d) {
      setText("club-brand-model", d.brandModel, "Not set");
      setText("club-type", d.clubType, "Not set");
      setText("club-distance", d.typicalDistance, "Not set");
      setText("club-use", d.shotUse, "Not set");
      setText("club-consistency", d.consistentSwing, "Not set");
      setText("club-notes", d.swingNotes, "None");
    }

    function getClubId() {
      const params = new URLSearchParams(window.location.search);
      const fromQuery = params.get("club");
      const fromHash = (window.location.hash || "").replace("#", "").trim();
      return (fromQuery || fromHash || "").trim();
    }

    async function loadFromWorker(clubId) {
      // Assumes your worker supports GET /club?clubId=1 (adjust if your route differs)
      const res = await fetch(`${WORKER_URL}/club?clubId=${encodeURIComponent(clubId)}`, { cache: "no-store" });
      if (!res.ok) throw new Error(await res.text());
      return await res.json();
    }

    window.addEventListener("load", async () => {
      const clubId = getClubId();
      if (!clubId) return alert("Missing club id in URL");

      // Optional: show instantly from localStorage while cloud loads
      const localKey = `club_${clubId}`;
      const cached = JSON.parse(localStorage.getItem(localKey) || "null");
      if (cached) render(cached);

      try {
        const cloud = await loadFromWorker(clubId);
        render(cloud);
        localStorage.setItem(localKey, JSON.stringify(cloud));
      } catch (e) {
        // If cloud read fails, keep cached display (if any)
        console.error("Cloud load failed:", e);
      }
    });

    document.getElementById("editBtn").addEventListener("click", async () => {
      const clubId = getClubId();
      if (!clubId) return alert("Missing club id in URL");

      const current = {
        brandModel: document.getElementById("club-brand-model").textContent || "",
        clubType: document.getElementById("club-type").textContent || "",
        typicalDistance: document.getElementById("club-distance").textContent || "",
        shotUse: document.getElementById("club-use").textContent || "",
        consistentSwing: document.getElementById("club-consistency").textContent || "",
        swingNotes: document.getElementById("club-notes").textContent || ""
      };

      const updated = {
        brandModel: prompt("Brand / Model", current.brandModel) ?? current.brandModel,
        clubType: prompt("Club type", current.clubType) ?? current.clubType,
        typicalDistance: prompt("Typical distance", current.typicalDistance) ?? current.typicalDistance,
        shotUse: prompt("Shot / use", current.shotUse) ?? current.shotUse,
        consistentSwing: prompt("Consistent swing", current.consistentSwing) ?? current.consistentSwing,
        swingNotes: prompt("Swing notes", current.swingNotes) ?? current.swingNotes
      };

      // Instant UI + local cache (no delay)
      render(updated);
      localStorage.setItem(`club_${clubId}`, JSON.stringify(updated));

      // Cloud save (durable)
      const res = await fetch(`${WORKER_URL}/save`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ clubId, data: updated })
      });

      if (!res.ok) {
        const t = await res.text();
        alert("Save failed:\n" + t + "\n\nYour changes are still on this device (local).");
        return;
      }

      // No reload. Done.
    });
  </script>

</body>
</html>
